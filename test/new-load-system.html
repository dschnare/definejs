<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title> new document </title>
        <meta charset="utf-8">
    </head>

    <body>
        <script type="text/javascript">
            var define = (function() {
                ///////////////////////////
                // Cross Browser Logging //
                ///////////////////////////
                function log() {
                    var i, len, arg, br, text, space, body;

                    body = document.body;
                    space = function() { return document.createTextNode(" "); };
                    br = function() { return document.createElement("br"); };
                    text = function(text) { return document.createTextNode(text + ""); };
                    len = arguments.length;

                    for (i = 0; i < len; i++) {
                        body.appendChild(text(arguments[i]));
                        body.appendChild(space());
                    }

                    body.appendChild(br());
                }




                var queue, context;

                //////////////////////////////////////
                // The Module Import Callback Queue //
                //////////////////////////////////////
                queue = (function() {
                    var queue = [];
                    queue.enqueue = function(o) {
                        this.push(o);
                    };
                    queue.dequeue = (function() {
                        var operation;
                        // Use pop() for Chrome, Safari, and FireFox - Embedded scripts are always executed first.
                        // Use shift for IE and Opera - Embedded scripts are always executed last.
                        if(window.navigator.userAgent.search(/safari|chrome|firefox/i) >= 0) {
                            operation = "pop";
                        } else {
                            operation = "shift";
                        }

                        return function() {
                            return this[operation]();
                        };
                    }());
                    queue.clear = function() {
                        while (this.length) this.pop();
                    };

                    return queue;
                }());

                function makeContext() {
                    var moduleExports = {}, moduleIdAlias = {};

                    return {
                        saveModuleExports: function(moduleId, exports) {
                            if (moduleId in moduleIdAlias) moduleId = moduleIdAlias[moduleId];
                            moduleExports[moduleId] = exports;
                        },
                        getModuleExports: function(moduleId) {
                            if (moduleId in moduleIdAlias) moduleId = moduleIdAlias[moduleId];
                            return moduleExports[moduleId];
                        },
                        containsModuleExports: function(moduleId) {
                            if (moduleId in moduleIdAlias) moduleId = moduleIdAlias[moduleId];
                            return moduleId in moduleExports;
                        },
                        aliasModuleId: function(moduleId, alias) {
                            moduleIdAlias[moduleId] = alias;
                        }
                    };
                }

                function makeConfig(o) {
                    return {
                        // TODO:
                    };
                }

                function loadScript(url) {
                    var script = document.createElement("script");

                    script.onload = function() {
                        delete context[url];

                        script.onload = null;
                        script.onreadystatechange = null;
                        script.onerror = null;

                        // Import the module's dependencies.
                        // pass the following: context, inferredModuleId, modulePath, url
                        queue.dequeue()();
                    };
                    script.onreadystatechange = function() {
                        if (script.readyState === "complete" || script.readyState === "loaded") {
                            script.onload();
                        }
                    };
                    script.onerror = function() {
                        delete context[url];

                        script.onload = null;
                        script.onreadystatechange = null;
                        script.onerror = null;

                        log("Failed to load script: " + url);
                    };

                    // TODO: define the module as 'loading'
                    context[url] = true;

                    script.src = url;
                    document.getElementsByTagName("head")[0].appendChild(script);
                }

                function moduleLoader(context, deps, moduleId) {
                    // Handle CommonJS dependcies
                        // Save the module exports immediately so that require() can get them without having to wait.
                        // Only do this if 'exports' is a dependency.
                        //context.saveModuleExports(name, exports);

                    // if the module is 'exported' then we abort with the exports
                    // if the module is 'loading' already then we abort with undefined (this could be a circular dependency)
                    // if the module is 'importing' then we wait for its exports; if it's a circular dpeendency then we abort with undefined
                    // else we load
                }

                function makeOptions() {
                    return {
                        // TODO:
                    };
                }

                function makeDefine(context) {

                    function define() {
                        var options, dependencies;

                        options = makeOptions.apply(undefined, arguments);
                        dependencies = options.dependencies;

                        var exports = dependencies.eports() || null;
                        // Define the module as 'importing'.
                        if (options.moduleId) context[options.moduleId] = {promise: {}, dependencies: dependencies};

                        // Enqueue a function that will import our dependencies.
                        queue.enqueue(function(/*context, inferredModuleId, modulePath, url*/) {
                            // TODO: Alias the inferredModuleID with the specified 'name' argument if it exists.

                            log("Run:", name);
                            if (deps) {
                                while (deps.length) {
                                    loadScript(deps.shift());
                                }

                                // TODO: when all dependencies are imported define the module as 'exported'
                                delete context[name];
                                context.saveModuleExports(/*exports from module*/);
                            }
                        });

                        log("Define:", name);

                        setTimeout(function() {
                            // Import the dependencies for all embedded modules.
                            if (queue.length) {
                                q = queue.slice();
                                queue.clear();

                                while (q.length) {
                                    q.shift()();
                                }
                            }
                        }, 0);
                    }

                    return define;
                }

                return (function() {
                    var context = makeContext();
                    context.config = makeConfig();
                    return makeDefine(context);
                }());
            }


            loadScript("scripts/a.js");
            loadScript("scripts/b.js");
            loadScript("scripts/c.js");
            loadScript("scripts/d.js");
            loadScript("scripts/e.js");
            loadScript("scripts/f.js");
            loadScript("scripts/g.js");
        </script>
        <script>
            define("embed1");
            define("embed2");
            define("embed3");
        </script>
        <script>
            define("embed4");
            define("embed5");
            define("embed6");
        </script>
    </body>
</html>